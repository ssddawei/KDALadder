<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Match</title>
  <script type="text/javascript" src="//gosspublic.alicdn.com/aliyun-oss-sdk-6.17.0.min.js"></script>
  <script type="text/javascript" src="res/config.js"></script>
  <script type="text/javascript" src="res/helper.js"></script>
  <script type="text/javascript" src="res/algorithm.js"></script>
  <script type="text/javascript" src="res/storage.js"></script>
  <script type="text/javascript" src="res/storage-localstorage.js"></script>
  <script type="text/javascript" src="res/sync.js"></script>
  <script type="text/javascript" src="res/sync-aliyun.js"></script>
  <script type="text/javascript" src="res/app.js"></script>
  <link rel="stylesheet" href="res/style.css">
  <style>
    .match {
      display: flex
    }
    .match.started .person .name {
      pointer-events:none;
    }

    .person {
      display: flex;
      flex-direction: column;
    }
    .person button {
      display: block
    }
    .notready button {
      pointer-events:none;
      opacity: 0.3;
    }
  </style>
</head>
<body class="match">
  <script id="PersonListItem" type="text/template">
    <div class="item" data-person="{{name}}">
      <div class="name">{{name}}</div>
      <div class="kda">{{kda}}</div>
    </div>
  </script>
  <div class="personList">
    <div class="list"></div>
    <div class="item newItemBtn">
      <div class="name">新增</div>
    </div>
    <div class="item cancelBtn">
      <div class="name">取消</div>
    </div>
  </div>
  
  <div class="menu">
    <button class="ladderBtn" onclick="location.href='ladder.html'">天梯</button>
    <button class="endBtn">结束</button>
    <button class="revertBtn">撤销</button>
    <button onclick="document.body.requestFullscreen();">全屏</button>
  </div>
  <button class="menuBtn">M<small>enu</small></button>

  <div class="score">
    <div class="aScore"></div>
    <div class="bScore"></div>
    <div class="time"></div>
  </div>
  <div class="match notready">
    <div class="person aGroup1">
      <img class="mvp" src="res/mvp.svg" />
      <img class="loser" src="res/loser.svg" />
      <div class="name"></div>
      <div class="kda"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
    </div>
    <div class="person aGroup2">
      <img class="mvp" src="res/mvp.svg" />
      <img class="loser" src="res/loser.svg" />
      <div class="name"></div>
      <div class="kda"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
    </div>
    <div class="person bGroup1">
      <img class="mvp" src="res/mvp.svg" />
      <img class="loser" src="res/loser.svg" />
      <div class="name"></div>
      <div class="kda"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
    </div>
    <div class="person bGroup2">
      <img class="mvp" src="res/mvp.svg" />
      <img class="loser" src="res/loser.svg" />
      <div class="name"></div>
      <div class="kda"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
    </div>
  </div>
  <script>
    let matchCtrl = new MatchController();
    let timeTmr;
    
    function refreshUI() {

      if(!timeTmr && matchCtrl.match.scores.length) {

        if(!matchCtrl.match.beginTime)
          matchCtrl.match.beginTime = Date.now();

        timeTmr = setInterval(()=>{
          let span = Math.floor((Date.now() - matchCtrl.match.beginTime)/1000);
          let minutes = Math.floor(span / 60);
          let seconds = span % 60;
          $sel("div.time").innerHTML = `${minutes}:${seconds}`;
        }, 1000);
      }
      matchCtrl.ready?
        $sel("div.match").classList.remove("notready"): 
        $sel("div.match").classList.add("notready");
      (matchCtrl.aScore > 0 || matchCtrl.bScore > 0)?
        $sel("div.match").classList.add("started"):
        $sel("div.match").classList.remove("started");

      // name
      $sel("div.aGroup1 .name").innerHTML = matchCtrl.aGroup[0] || "(empty)";
      $sel("div.aGroup2 .name").innerHTML = matchCtrl.aGroup[1] || "(empty)";
      $sel("div.bGroup1 .name").innerHTML = matchCtrl.bGroup[0] || "(empty)";
      $sel("div.bGroup2 .name").innerHTML = matchCtrl.bGroup[1] || "(empty)";
      
      // match score
      if($sel(".aScore").innerHTML != matchCtrl.aScore)
      {// active animate
        $sel(".aScore").classList.add("puff-out-center-3");
        $sel(".aScore").style.animation = 'none';
        $sel(".aScore").offsetHeight; /* trigger reflow */
        $sel(".aScore").style.animation = ''; 
        $sel(".aScore").innerHTML = `${matchCtrl.aScore}`
      }
      if($sel(".bScore").innerHTML != matchCtrl.bScore)
      {// active animate
        $sel(".bScore").classList.add("puff-out-center-3");
        $sel(".bScore").style.animation = 'none';
        $sel(".bScore").offsetHeight; /* trigger reflow */
        $sel(".bScore").style.animation = ''; 
        $sel(".bScore").innerHTML = `${matchCtrl.bScore}`
      }

      // kda
      let applyKDA = (person, target) => {
        let kda = matchCtrl.kda(person);
        $sel(target).innerHTML = `${kda.kill} / ${kda.death} / ${kda.assist}`;
      }
      
      applyKDA(matchCtrl.aGroup[0], ".aGroup1 .kda");
      applyKDA(matchCtrl.aGroup[1], ".aGroup2 .kda");
      applyKDA(matchCtrl.bGroup[0], ".bGroup1 .kda");
      applyKDA(matchCtrl.bGroup[1], ".bGroup2 .kda");

      // mvp
      let mvp = matchCtrl.mvp();
      let loser = matchCtrl.loser();
      
      $sels("div.match .person").forEach(i => i.classList.remove("mvp"))
      $sels("div.match .person").forEach(i => i.classList.remove("loser"))

      let personToTarget = (person) => {
        let idx = matchCtrl.match.personGroup.map((i,idx)=>i==person? idx: null)
          .filter(i=>i!==null)[0];
        return [".aGroup1", ".aGroup2", ".bGroup1", ".bGroup2"][idx];
      }
      
      if(matchCtrl.started) {
        $sel(personToTarget(mvp)).classList.add("mvp");
        $sel(personToTarget(loser)).classList.add("loser");
      }


      matchCtrl.save();
    }
    

    $sel("div.aGroup1 .goalBtn").addEventListener("click", () => {
      matchCtrl.goal(matchCtrl.aGroup[0]);
      refreshUI();
    })
    $sel("div.aGroup2 .goalBtn").addEventListener("click", () => {
      matchCtrl.goal(matchCtrl.aGroup[1]);
      refreshUI();
    })
    $sel("div.bGroup1 .goalBtn").addEventListener("click", () => {
      matchCtrl.goal(matchCtrl.bGroup[0]);
      refreshUI();
    })
    $sel("div.bGroup2 .goalBtn").addEventListener("click", () => {
      matchCtrl.goal(matchCtrl.bGroup[1]);
      refreshUI();
    })

    $sel("div.aGroup1 .lossBtn").addEventListener("click", () => {
      matchCtrl.loss(matchCtrl.aGroup[0]);
      refreshUI();
    })
    $sel("div.aGroup2 .lossBtn").addEventListener("click", () => {
      matchCtrl.loss(matchCtrl.aGroup[1]);
      refreshUI();
    })
    $sel("div.bGroup1 .lossBtn").addEventListener("click", () => {
      matchCtrl.loss(matchCtrl.bGroup[0]);
      refreshUI();
    })
    $sel("div.bGroup2 .lossBtn").addEventListener("click", () => {
      matchCtrl.loss(matchCtrl.bGroup[1]);
      refreshUI();
    })

    $sel(".revertBtn").addEventListener("click", () => {
      if(!matchCtrl.match.scores.length){
        $alert("对不起，办不到。");
        return;
      }
      matchCtrl.revert();
      if(!matchCtrl.match.scores.length && timeTmr) {
        clearInterval(timeTmr)
        timeTmr = null;
      }
      refreshUI();
    })

    $sel(".endBtn").addEventListener("click", async () => {
      if(!matchCtrl.started){
        $alert("比赛都没开始，结束你个头。");
        return;
      }
      let beginTime = matchCtrl.match.beginTime;
      try{
        let date = await matchCtrl.end();
        if(date)
          location.href = `match-result.html?${date}-${beginTime}`
      } catch(e) {
        $alert("sync error " + e);
        throw e;
      }
    })

    class PersonChooser {
      chooseCallback;
      constructor() {
        $sel("div.personList .list").addEventListener("click", (e) => {
          let person = e.path.filter(i => i.dataset && i.dataset["person"])[0];
          this.selectPerson(person && person.dataset["person"]);
        })
        $sel("div.personList .newItemBtn").addEventListener("click", async () => {
          let newPerson = await $prompt("输入新成员名字");
          this.selectPerson(newPerson);
        })
        $sel("div.personList .cancelBtn").addEventListener("click", () => {
          this.cancel();
        });
      }
      refreshUI() {
        let remote = new LocalStorage("remote");
        let ladder = remote.ladder[$seasonString(new Date())];
        if(ladder) {
          let tpl = $sel("#PersonListItem").innerHTML;
          $sel("div.personList > .list").innerHTML = remote.ladder[$seasonString(new Date())].ladder.map(p => {
            let item = tpl.replaceAll("{{name}}", p.person)
              .replace("{{kda}}", `${p.score.toFixed(1)} ${p.kill}/${p.death}/${p.assist} ${(p.win/(p.win+p.loss)*100).toFixed(1)}%`)
            return item;
          }).join("");
        }
      }
      selectPerson(person) {
        this.chooseCallback && this.chooseCallback(person);
        $sel(".personList").classList.remove("show")
      }
      cancel() {
        this.chooseCallback && this.chooseCallback();
        $sel(".personList").classList.remove("show")
      }
      async choose() {
        this.refreshUI();
        $sel(".personList").classList.add("show")

        return await new Promise(done => {
          this.chooseCallback = done;
        })
      };
    }
    
    let personChooser = new PersonChooser();

    $sel("div.aGroup1 .name").addEventListener("click", async function(){
      let person = await personChooser.choose();
      person && (matchCtrl.match.personGroup[0] = person);
      refreshUI();
    })
    $sel("div.aGroup2 .name").addEventListener("click", async function(){
      let person = await personChooser.choose();
      person && (matchCtrl.match.personGroup[1] = person);
      refreshUI();
    })
    $sel("div.bGroup1 .name").addEventListener("click", async function(){
      let person = await personChooser.choose();
      person && (matchCtrl.match.personGroup[2] = person);
      refreshUI();
    })
    $sel("div.bGroup2 .name").addEventListener("click", async function(){
      let person = await personChooser.choose();
      person && (matchCtrl.match.personGroup[3] = person);
      refreshUI();
    })

    let menu = new Menu();

    matchCtrl.load();
    matchCtrl.match.personGroup = ['a', 'b', 'c', 'd'];
    matchCtrl.goal('a');
    matchCtrl.goal('c');
    refreshUI();

  </script>
</body>
</html>