<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Match</title>
  <script type="text/javascript" src="res/nosleep.min.js"></script>
  <script type="text/javascript" src="res/qrcode.min.js"></script>
  <link rel="stylesheet" href="res/icomoon/style.css">
  <link rel="stylesheet" href="res/style.css">
  <style>
    .match {
      display: flex
    }
    /* .match.started .person .name {
      pointer-events:none;
    } */

    .person {
      display: flex;
      flex-direction: column;
    }
    .person button {
      display: block
    }
    .notready button {
      pointer-events:none;
      opacity: 0.3;
    }
    .CDBtn.disabled,
    .ExtraEnableBtn.disabled {
      text-decoration: line-through;
      color: red
    }
  </style>
</head>
<body class="match">
  <script id="DataListItem" type="text/template">
    <div class="item {{active}}" data-data="{{data}}">
      <div class="data">{{data}}</div>
      <div class="subtitle">{{subtitle}}</div>
    </div>
  </script>
  <div class="dataList">
    <div class="list"></div>
    <div class="item newItemBtn">
      <div class="name">新增</div>
    </div>
    <div class="item cancelBtn">
      <div class="name">取消</div>
    </div>
  </div>
  
  <div class="pop-result">
    <iframe src="" title="result"></iframe>
    <button class="close-pop-result">关闭</button>
  </div>

  <div class="connect">
    <div class="subgroup">1</div>
    <img src="res/svg/sync.svg" alt="" />
  </div>
	
  <div class="nosleep">点击激活屏幕锁亮</div>

  <div class="menu">
    <button class="homeBtn"><em class="icon-back"></em>返回首页</button>
    <button class="prevMatchBtn" ><em class="icon-back"></em>上局结果</button>
    <button class="ladderBtn" style="display:none"><em class="icon-back"></em>天梯</button>
    <div class="sep"></div>
    <button class="endBtn"><em class="icon-flag"></em>结束</button>
    <button class="revertBtn"><em class="icon-revert"></em>撤销</button>
    <div class="sep"></div>
    <button class="channelBtn"><em class="icon-sync"></em>切换信道(<span class="subgroup"></span>)</button>
    <button onclick="location.replace('board.html')"><em class="icon-airplay"></em>看板模式</button>
    <button class="musicBtn"><em class="icon-music"></em>音效开关</button>
    <button class="CDBtn"><em class="icon-cd"></em>CD开关</button>
    <button class="ExtraEnableBtn"><em class="icon-kda-a"></em>技术统计开关</button>
    <button onclick="document.body.requestFullscreen();"><em class="icon-fullscreen"></em>全屏</button>    
    <div class="sep"></div>
    <button class="QRBtn"></em># 网址二维码</button>
  </div>
  <button class="menuBtn">
    M<small>enu</small>
  </button>

  <button class="gRevertBtn">撤销</button>
  <button class="gEndBtn">结束</button>

  <div class="score">
    <div class="aScore">/</div>
    <div class="bScore">/</div>
    <div class="time"></div>
  </div>
  <div class="match notready cooldown5">
    <div class="person aGroup1">
      <img class="mvp" src="res/svg/mvp.svg" alt="" />
      <img class="loser" src="res/svg/loser.svg" alt="" />
      <div class="name"></div>
      <div class="kda"></div>
      <div class="killTag"></div>
      <div class="deathTag"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
      <div class="goalBtnExtra">
        <button data-extra="smash-kill" class="extraBtn killShotBtn">杀球得分</button>
        <button data-extra="drop-kill" class="extraBtn deadlyshotBtn">落点得分</button>
        <button data-extra="fast-kill" class="extraBtn fastReturnBtn">抽挡得分</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
      <div class="lossBtnExtra">
        <button data-extra="out-fall" class="extraBtn">出界落网</button>
        <button data-extra="serve-fall" class="extraBtn">发球失误</button>
        <button data-extra="air-fall" class="extraBtn">误击空击</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
    </div>
    <div class="person aGroup2">
      <img class="mvp" src="res/svg/mvp.svg" alt="" />
      <img class="loser" src="res/svg/loser.svg" alt="" />
      <div class="name"></div>
      <div class="kda"></div>
      <div class="killTag"></div>
      <div class="deathTag"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
      <div class="goalBtnExtra">
        <button data-extra="smash-kill" class="extraBtn killShotBtn">杀球得分</button>
        <button data-extra="drop-kill" class="extraBtn deadlyshotBtn">落点得分</button>
        <button data-extra="fast-kill" class="extraBtn fastReturnBtn">抽挡得分</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
      <div class="lossBtnExtra">
        <button data-extra="out-fall" class="extraBtn">出界落网</button>
        <button data-extra="serve-fall" class="extraBtn">发球失误</button>
        <button data-extra="air-fall" class="extraBtn">误击空击</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
    </div>
    <div class="person bGroup1">
      <img class="mvp" src="res/svg/mvp.svg" alt="" />
      <img class="loser" src="res/svg/loser.svg" alt="" />
      <div class="name"></div>
      <div class="kda"></div>
      <div class="killTag"></div>
      <div class="deathTag"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
      <div class="goalBtnExtra">
        <button data-extra="smash-kill" class="extraBtn killShotBtn">杀球得分</button>
        <button data-extra="drop-kill" class="extraBtn deadlyshotBtn">落点得分</button>
        <button data-extra="fast-kill" class="extraBtn fastReturnBtn">抽挡得分</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
      <div class="lossBtnExtra">
        <button data-extra="out-fall" class="extraBtn">出界落网</button>
        <button data-extra="serve-fall" class="extraBtn">发球失误</button>
        <button data-extra="air-fall" class="extraBtn">误击空击</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
    </div>
    <div class="person bGroup2">
      <img class="mvp" src="res/svg/mvp.svg" alt="" />
      <img class="loser" src="res/svg/loser.svg" alt="" />
      <div class="name"></div>
      <div class="kda"></div>
      <div class="killTag"></div>
      <div class="deathTag"></div>
      <button class="goalBtn">O</button>
      <button class="lossBtn">X</button>
      <div class="goalBtnExtra">
        <button data-extra="smash-kill" class="extraBtn killShotBtn">杀球得分</button>
        <button data-extra="drop-kill" class="extraBtn deadlyshotBtn">落点得分</button>
        <button data-extra="fast-kill" class="extraBtn fastReturnBtn">抽挡得分</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
      <div class="lossBtnExtra">
        <button data-extra="out-fall" class="extraBtn">出界落网</button>
        <button data-extra="serve-fall" class="extraBtn">发球失误</button>
        <button data-extra="air-fall" class="extraBtn">误击空击</button>
        <button data-extra="unknown" class="extraBtn cancelBtn selected">（未知）</button>
      </div>
    </div>
  </div>
  <div class="qrcode"><div class="qrcodeImg"></div><div class="qrcodeTitle">KDALadder.top</div></div>
  
  <script type="module">
    import * as App from './res/app.js'
    import { LocalStorage } from './res/storage-localstorage.js'
    import { Match } from './res/storage.js'
    Object.assign(window, App);

    const token = window.token = location.search.slice(1);

    let PrevMatchRecord = localStorage.getItem("__PrevMatchRecord");
    let CDDisabled = (!!localStorage.getItem("cd-disabled"));
    let ExtraDisabled = (!!localStorage.getItem("extra-disabled"));
    let timeTmr;
    let matchCtrl = new MatchController();
    let connectCtrl = window.connectCtrl = new ConnectController(token, (data) => {
      switch(data.action) {
        case "connect": {
          SoundEffect.disabled = true;
          break;
        }
        case "cooldown": {
          SoundEffect.play("cooldown", 1);
          break;
        }
        case "match": {
          matchCtrl.match = data.data;
          refreshUI();
          break;
        }
        case "revert": {
          matchCtrl.revert();
          refreshUI();
          break;
        }
        case "end": {
          let beginTime = matchCtrl.match.beginTime;
          let date = $dateString(new Date(beginTime));
          new LocalStorage("current").delete();
          matchCtrl.match = new Match();
          refreshUI();
          $sel(".pop-result iframe").src = `match-result.html?${date}-${beginTime}&embedded`
          $sel(".pop-result").classList.add('show')
          break;
        }
        case "close-result": {
          $sel(".pop-result").classList.remove('show')
        }
      }
    })
    
    
    window.addEventListener("click", () => {
			if(!window._nosleep){
        window._nosleep = new NoSleep();
        window._nosleep.enable();
        $sel(".nosleep").classList.add("active")
      }
    })
    window.addEventListener("touchend", () => {
			if(!window._nosleep){
        window._nosleep = new NoSleep();
        window._nosleep.enable();
        $sel(".nosleep").classList.add("active")
      }
    })

    window.__personSort = JSON.parse(localStorage.getItem("__personSort")||"[]");
    let personChooser = new ListChooser( async () => {
      let result = [];
      
      { // current season
        let ladder = await new LadderController(token).seasonLadder();
        result = result.concat(ladder.ladder.map(p => ({
          data: p.person,
          subtitle: `赛季成绩：${p.score.toFixed(2)}`
        })).filter(i => {
          return !ladder.ladder.find(j => j.person == i.person)
        }))
      }
      { // pre season
        let preSeason = new Date();
        preSeason.setMonth(preSeason.getMonth() - 3);
        let ladder = await new LadderController(token).seasonLadder($seasonString(preSeason));
        result = result.concat(ladder.ladder.map(p => ({
          data: p.person,
          subtitle: `上赛季成员`
        })).filter(i => {
          return !result.find(j => j.data == i.data)
        }))
      }
      result.sort((a,b) => {
        return window.__personSort.indexOf(b.data) - window.__personSort.indexOf(a.data)
      })
      return result;
    }, true);
    $sel("div.dataList .newItemBtn").addEventListener("click", async () => {
      let newPerson = await $prompt("输入新成员名字");
      personChooser.select(newPerson);
    })

    // sync match by ConnectController
    function connectSync(action, data) {
      if(action)
        connectCtrl.send(action, data);
      else
        connectCtrl.send("match", matchCtrl.match);
    }

    function refreshUI() {

      if(!timeTmr && matchCtrl.match.scores.length) {

        timeTmr = setInterval(()=>{
          if(!matchCtrl.started) return;
          let span = Math.floor((Date.now() - matchCtrl.match.beginTime)/1000);
          let minutes = Math.floor(span / 60);
          let seconds = span % 60;
          $sel("div.time").innerHTML = `${minutes}:${seconds}`;
        }, 1000);
      }

      if(matchCtrl.ready) {
        if($sel("div.match").classList.contains("notready")) {
          $sel("div.match").classList.remove("notready");
          // force refresh. cause Safari will not re-render the button
          $sel("div.match").style.display = 'none';
          $sel("div.match").offsetHeight;
          $sel("div.match").style.display = '';
        }
      } else {
        if(!$sel("div.match").classList.contains("notready")) {
          $sel("div.match").classList.add("notready");
        }
      }
        
      (matchCtrl.aScore > 0 || matchCtrl.bScore > 0)?
        $sel("div.match").classList.add("started"):
        $sel("div.match").classList.remove("started");
      
      // name
      $sel("div.aGroup1 .name").innerHTML = matchCtrl.aGroup[0] || "(选人)";
      $sel("div.aGroup2 .name").innerHTML = matchCtrl.aGroup[1] || "(选人)";
      $sel("div.bGroup1 .name").innerHTML = matchCtrl.bGroup[0] || "(选人)";
      $sel("div.bGroup2 .name").innerHTML = matchCtrl.bGroup[1] || "(选人)";
      
      // match score
      if($sel(".aScore").innerHTML != matchCtrl.aScore)
      {// active animate
        $sel(".aScore").classList.add("puff-out-center-3");
        $sel(".aScore").style.animation = 'none';
        $sel(".aScore").offsetHeight; /* trigger reflow */
        $sel(".aScore").style.animation = ''; 
        $sel(".aScore").innerHTML = `${matchCtrl.aScore}`
      }
      if($sel(".bScore").innerHTML != matchCtrl.bScore)
      {// active animate
        $sel(".bScore").classList.add("puff-out-center-3");
        $sel(".bScore").style.animation = 'none';
        $sel(".bScore").offsetHeight; /* trigger reflow */
        $sel(".bScore").style.animation = ''; 
        $sel(".bScore").innerHTML = `${matchCtrl.bScore}`
      }

      // kda
      let applyKDA = (person, target) => {
        let kda = matchCtrl.kda(person);
        $sel(target).innerHTML = `${kda.kill} / ${kda.death} / ${kda.assist}`;
      }
      

      applyKDA(matchCtrl.aGroup[0], ".aGroup1 .kda");
      applyKDA(matchCtrl.aGroup[1], ".aGroup2 .kda");
      applyKDA(matchCtrl.bGroup[0], ".bGroup1 .kda");
      applyKDA(matchCtrl.bGroup[1], ".bGroup2 .kda");

      // mvp
      let mvp = matchCtrl.mvp();
      let loser = matchCtrl.loser();
      
      $sels("div.match .person").forEach(i => i.classList.remove("mvp"))
      $sels("div.match .person").forEach(i => i.classList.remove("loser"))

      let personToTarget = (person) => {
        let idx = matchCtrl.match.personGroup.map((i,idx)=>i==person? idx: null)
          .filter(i=>i!==null)[0];
        return [".aGroup1", ".aGroup2", ".bGroup1", ".bGroup2"][idx];
      }
      
      // next event
      // [".aGroup1", ".aGroup2", ".bGroup1", ".bGroup2"].forEach((i, idx) => {
      //   let kEvent = matchCtrl.nextEvent(matchCtrl.match.personGroup[idx], true);
      //   let dEvent = matchCtrl.nextEvent(matchCtrl.match.personGroup[idx], false);
      //   $sel(i + " .killTag").innerHTML = kEvent && kEvent[0] && KDAEventCalc.NameToEN[kEvent[0].name] || ""
      //   $sel(i + " .deathTag").innerHTML = dEvent && dEvent[0] && KDAEventCalc.NameToEN[dEvent[0].name] || ""
      // })
      if(matchCtrl.started) {
        $sel(personToTarget(mvp)).classList.add("mvp");
        $sel(personToTarget(loser)).classList.add("loser");
      }

      $sel(".gEndBtn").style.display = matchCtrl.readyToEnd? "block": "none"

      // CDBtn
      if(CDDisabled) {
        $sel(".CDBtn").classList.add("disabled");
      } else {
        $sel(".CDBtn").classList.remove("disabled");
      }
      if(ExtraDisabled) {
        $sel(".ExtraEnableBtn").classList.add("disabled");
      } else {
        $sel(".ExtraEnableBtn").classList.remove("disabled");
      }
      
      $sels(".goalBtn,.lossBtn").forEach(function(i) {
        if(i.dataset.waitExtra) {
          i.parentElement.querySelectorAll(".goalBtn,.lossBtn").forEach(
            j=>j.style.display = "none"
          )
          if(i.classList.contains("goalBtn"))
            i.parentElement.querySelector(".goalBtnExtra")
              .style.display = "block";
          else
            i.parentElement.querySelector(".lossBtnExtra")
              .style.display = "block"
        }
      })

      $sels(".subgroup").forEach(i=>i.innerHTML = connectCtrl.subgroup);
      
      matchCtrl.save();
    }
    
    function activeCD(faster) {
      let CD = faster? 2000: 5000;

      if(!matchCtrl.readyToEnd) {
        $sel(".gRevertBtn").style.display = "block";
      }

      // CD
      $sels(".goalBtn,.lossBtn,.extraBtn").forEach(function(i){
        !CDDisabled && i.classList.remove("cooldown", "cooldown"+(CD))
        !CDDisabled && i.offsetHeight /* trigger reflow */
        !CDDisabled && i.classList.add("cooldown", "cooldown"+(CD));
      });

      clearTimeout(window.__cdTmr);
      window.__cdTmr = setTimeout(cancelCD, CD)
    }
    function cancelCD() {
      $sel(".gRevertBtn").style.display = "none";
      $sels(".goalBtn,.lossBtn,.extraBtn").forEach(function(i){
        i.classList.remove("cooldown", "cooldown5000", "cooldown2000");
      });
      
      $sels(".goalBtn,.lossBtn").forEach(function(i){
        if(i.dataset.waitExtra) {
          delete i.dataset.waitExtra;
        }
      });
      $sels(".goalBtnExtra,.lossBtnExtra,.extraBtn,.goalBtn,.lossBtn").forEach(i => {
        i.classList.remove("selected");
        i.style.display = '';
      })
      $sels(".extraBtn.cancelBtn").forEach(i=>i.classList.add("selected"))
    }
    function onScore() {
      if(!CDDisabled)
        activeCD()
    }

    function onExtra() {
      CDDisabled? cancelCD(): activeCD(true)
    }

    ["div.aGroup1", "div.aGroup2", "div.bGroup1", "div.bGroup2"].forEach((i, idx) => {

      $sel(i + " .goalBtn").addEventListener("click", function(){
        if(!CDDisabled && this.classList.contains("cooldown")) {
          SoundEffect.play("cooldown", 1); connectSync("cooldown")
          return;
        }
        if(!ExtraDisabled)
          this.dataset.waitExtra = idx;
        $activeAnimate(this);
        matchCtrl.goal(matchCtrl.match.personGroup[idx]);
        connectSync();
        refreshUI();
        onScore();
      });

      $sel(i + " .lossBtn").addEventListener("click", function(){
        if(!CDDisabled && this.classList.contains("cooldown")) {
          SoundEffect.play("cooldown", 1); connectSync("cooldown")
          return;
        }
        if(!ExtraDisabled)
          this.dataset.waitExtra = idx;
        $activeAnimate(this);
        matchCtrl.loss(matchCtrl.match.personGroup[idx]);
        connectSync();
        refreshUI();
        onScore();
      })

      $sels(i + " .extraBtn").forEach(j=>j.addEventListener("click", function(){
        // if(!CDDisabled && this.classList.contains("cooldown"+(CD))) {
        //   SoundEffect.play("cooldown", 1); connectSync("cooldown")
        //   return;
        // }
        $sels(i + " .extraBtn").forEach(i=>i.classList.remove("selected"))
        matchCtrl.extra(this.dataset.extra||"unknown");
        this.classList.add("selected")
        $activeAnimate(this);
        connectSync();
        refreshUI();
        onExtra();
      }))

      //Select Person
      async function selectPerson(){
        $sel("div.dataList .newItemBtn").style.display = "";
        let person = await personChooser.choose();

        matchCtrl.started?
          matchCtrl.changePerson(matchCtrl.match.personGroup[idx], person):
          (matchCtrl.match.personGroup[idx] = person);

        { // sort when show chooser
          window.__personSort = window.__personSort.filter(i=>i!=person);
          window.__personSort.push(person);
          localStorage.setItem("__personSort", JSON.stringify(window.__personSort))
        }
        connectSync();
        refreshUI();
      }
      $sel(i + " .name").addEventListener("click", ()=>{
        if(matchCtrl.started)return;
        selectPerson()
      })

      $sel(i + " .name").addEventListener("dblclick", ()=>{
        selectPerson()
      })
    })

    $sels(".revertBtn,.gRevertBtn").forEach(i=>i.addEventListener("click", () => {
      if(!matchCtrl.match.scores.length){
        $alert("对不起，办不到。");
        return;
      }
      matchCtrl.revert();
      if(!matchCtrl.match.scores.length && timeTmr) {
        clearInterval(timeTmr)
        timeTmr = null;
      }
      connectSync("revert");
      refreshUI();

      // reset cd
      cancelCD();
    }))

    $sels(".endBtn,.gEndBtn").forEach(i=>i.addEventListener("click", async function(){
      if(!matchCtrl.started){
        $alert("比赛都没开始，结束你个头。");
        return;
      }
      if(!matchCtrl.readyToEnd) {
        if(!await $confirm("比赛看似还没结束，确定？")) {
          return;
        }
      }
      else if(!await $confirm("确定结束？", true)) {
        return;
      }

      cancelCD();
      
      let beginTime = matchCtrl.match.beginTime;
      try{
        this.disabled = "disabled"
        let date = await matchCtrl.end(token);
        refreshUI();
        connectSync("end")
        if(date) {
          $sel(".pop-result iframe").src = PrevMatchRecord = `match-result.html?${date}-${beginTime}&embedded`
          $sel(".pop-result").classList.add('show')
          localStorage.setItem("__PrevMatchRecord", PrevMatchRecord)
        }
        this.disabled = ""
      } catch(e) {
        this.disabled = ""
        $alert("sync error " + e);
        throw e;
      }
    }));

    $sel(".close-pop-result").addEventListener("click", () => {
      $sel('.pop-result').classList.remove('show');
      connectSync("close-result")
    })

    $sel(".CDBtn").addEventListener("click", () => {
      CDDisabled = !CDDisabled;
      CDDisabled? 
        localStorage.setItem("cd-disabled", true):
        localStorage.removeItem("cd-disabled")
      refreshUI();
    })
    
    $sel(".ExtraEnableBtn").addEventListener("click", () => {
      ExtraDisabled = !ExtraDisabled;
      ExtraDisabled? 
        localStorage.setItem("extra-disabled", true):
        localStorage.removeItem("extra-disabled")
      refreshUI();
    })

    let channelChooser = new ListChooser( async () => {
      return [1,2,3,4,5,6,7,8].map(p => ({
        data: p,
        active: p == connectCtrl.subgroup,
        subtitle: `信道${p}`
      }))
    }, true);
    $sel(".channelBtn").addEventListener("click", async () => {
      $sel("div.dataList .newItemBtn").style.display = "none";
      connectCtrl.subgroup = await channelChooser.choose() || connectCtrl.subgroup;
      refreshUI();
    })
    $sel(".QRBtn").addEventListener("click", () => {
      if(!window.__hasQrcode) {
        window.__hasQrcode = true;
        new QRCode($sel(".qrcode .qrcodeImg"), location.origin);
      }
      if($sel(".qrcode").style.display == "flex")
        $sel(".qrcode").style.display = "none"
      else
        $sel(".qrcode").style.display = "flex"
    })
    $sel(".qrcode").addEventListener("click", () => {
      $sel(".qrcode").style.display = "none"
    })
    
    let popResult = (url) => {
      $sel(".pop-result iframe").src = url
      $sel(".pop-result").classList.add('show')
      $pushHistoryBack(()=>{
        $sel('.pop-result').classList.remove('show');
      })
    }
    $sel(".connect").addEventListener("click", () => {
      popResult("connect.html" + location.search)
    })
    $sel(".ladderBtn").addEventListener("click", () => {
      popResult("ladder.html")
    })
    $sel(".prevMatchBtn").addEventListener("click", () => {
      if(PrevMatchRecord)
        popResult(PrevMatchRecord);
      else
        $alert("没有记录")
    })
    $sel(".homeBtn").addEventListener("click", async () => {
      if(await $confirm("确定退出？"))
        location.href='index.html'
    })

    window.refreshUI = refreshUI;

    let menu = new Menu();
    matchCtrl.load();
    refreshUI();

  </script>
</body>
</html>