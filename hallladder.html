<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ladder</title>
  <link rel="stylesheet" href="res/icomoon/style.css">
  <link rel="stylesheet" href="res/style.css">
  <style>
    .matches {
      display: flex
    }
    .matches .item {
      margin: 5px;
      padding: 5px;
    }
    .matches .item .title {
      color: gray
    }
    .matches .item .score {
      color: red
    }
  </style>
</head>
<body class="ladder hall">

  <div class="box ladderBox">
    <h1># 全服KDA天梯排名</h1>
    <small>2022-season1</small>
    <script id="LadderItem" type="text/template">
      <div class="item">
        <div class="name">{{name}}</div>
        <div class="score" style="width:{{width}}%"><span>{{score}}</span></div>
      </div>
    </script>

    <div title="总分 &nbsp; 击杀 / 失误 / 助攻 / &nbsp;  胜率% ( 胜场数 / 败场数 )" class="ladder-help place-holder-owner">
      <i class="icon-medal"></i> &nbsp; <i class="icon-kda-k"></i> / <i class="icon-kda-d"></i> / <i class="icon-kda-a"></i> / &nbsp;  <i class="icon-win"></i>% ( <i class="icon-win"></i> / <i class="icon-loss"></i> ) &nbsp; <i class="icon-rocket"></i>%
    </div>
    <div class="ladder-help place-holder">
      总分 &nbsp; 击杀 / 失误 / 助攻 / &nbsp;  胜率% ( 胜场数 / 败场数 )&nbsp; 团体加成
    </div>
    <div class="ladder">
    </div>
  </div>
  </div>
  <script type="module">
    import * as App from './res/app.js'
    import { LocalStorage } from './res/storage-localstorage.js'
    Object.assign(window, App);
    
    let ladderCtrl = new LadderController();
    let ladderDate = $seasonString(new Date());


    async function refreshUI() {

      var tmpl;

      $sel("div.ladder").innerHTML = "loading..."

      let ladder = await ladderCtrl.seasonHallLadder(ladderDate);

      $sel(".ladderBox > small").innerHTML = ladderDate;

      if(ladder && ladder.ladder.length) {

        // ladder 
        tmpl = $sel("#LadderItem").innerHTML;

        let maxScore = ladder.ladder[0].score;
        $sel("div.ladder").innerHTML = ladder.ladder.map(i => {
          let width = Math.floor(i.score / maxScore * 100 * 0.7);
          let item = tmpl.replace("{{name}}", i.person + `<small>${i.group}</small>`)
            .replace(/{{score}}/g, $kdaString(i, true) + ' <em class="icon-rocket"></em>' + (i.quality * 100).toFixed(0) + '%')
            .replace("{{width}}", width)
          return item;
        }).join("");

      } else {
        $sel("div.ladder").innerHTML = "暂无数据"
      }


    }

    let ladderChooser = new parent.ListChooser(() => {
      let remote = new LocalStorage("remote");

      let currentSeason = $seasonString(new Date())
      let prevSeason = [0, 1,2,3].map(i => {
        let date = new Date();
        date.setDate(1);
        date.setMonth(date.getMonth() - 3 * i)
        return $seasonString(date);
      })
      return prevSeason;
    });

    $sel(".ladderBox > h1").addEventListener("click", async ()=>{
      ladderDate = await ladderChooser.choose() || ladderDate;
      refreshUI();
    });
    
    refreshUI();
  </script>
</body>
</html>