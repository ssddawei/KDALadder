<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ladder</title>
  <script type="text/javascript" src="res/config.js"></script>
  <script type="text/javascript" src="res/helper.js"></script>
  <script type="text/javascript" src="res/algorithm.js"></script>
  <script type="text/javascript" src="res/storage.js"></script>
  <script type="text/javascript" src="res/storage-localstorage.js"></script>
  <script type="text/javascript" src="res/sync.js"></script>
  <script type="text/javascript" src="res/sync-server.js"></script>
  <script type="text/javascript" src="res/app.js"></script>
  <link rel="stylesheet" href="res/icomoon/style.css">
  <link rel="stylesheet" href="res/style.css">
  <style>
    .matches {
      display: flex
    }
    .matches .item {
      margin: 5px;
      padding: 5px;
    }
    .matches .item .title {
      color: gray
    }
    .matches .item .score {
      color: red
    }
  </style>
</head>
<body class="ladder hall">

  <div class="box ladderBox">
    <h1># 全服KDA天梯排名</h1>
    <small>2022-season1</small>
    <script id="LadderItem" type="text/template">
      <div class="item">
        <div class="name">{{name}}</div>
        <div class="score" style="width:{{width}}%"><span>{{score}}</span></div>
      </div>
    </script>

    <div title="总分 &nbsp; 击杀 / 失误 / 助攻 / &nbsp;  胜率% ( 胜场数 / 败场数 )" class="ladder-help place-holder-owner">
      <i class="icon-medal"></i> &nbsp; <i class="icon-kda-k"></i> / <i class="icon-kda-d"></i> / <i class="icon-kda-a"></i> / &nbsp;  <i class="icon-win"></i>% ( <i class="icon-win"></i> / <i class="icon-loss"></i> ) &nbsp; <i class="icon-rocket"></i>%
    </div>
    <div class="ladder-help place-holder">
      总分 &nbsp; 击杀 / 失误 / 助攻 / &nbsp;  胜率% ( 胜场数 / 败场数 )&nbsp; 团体加成
    </div>
    <div class="ladder">
    </div>
  </div>
  </div>
  <script>

    let ladderCtrl = new LadderController();
    let ladderDate = $seasonString(new Date());


    async function refreshUI() {

      var tmpl;
      let ladder = await ladderCtrl.seasonHallLadder(ladderDate);

      $sel(".ladderBox > small").innerHTML = ladderDate;

      if(ladder) {

        // ladder 
        tmpl = $sel("#LadderItem").innerHTML;

        let maxScore = ladder.ladder[0].score;
        $sel("div.ladder").innerHTML = ladder.ladder.map(i => {
          let width = Math.floor(i.score / maxScore * 100 * 0.7);
          let item = tmpl.replace("{{name}}", i.person + `<small>${i.group}</small>`)
            .replace(/{{score}}/g, $kdaString(i, true) + ' <em class="icon-rocket"></em>' + (i.quality * 100).toFixed(0) + '%')
            .replace("{{width}}", width)
          return item;
        }).join("");

      }


    }

    let ladderChooser = new parent.ListChooser(() => {
      let remote = new LocalStorage("remote");
      let allDates = Array.from(
        new Set(
          Object.values(remote.ladder).reduce((pre,nxt) => pre.concat(nxt), []) // all ladders
            .map(i => $dateString(new Date(i.beginTime))) // map to dateString
            // .concat($dateString(new Date()))  // add today
            .concat(Object.keys(remote.ladder)) // add seasonString
            .concat($seasonString(new Date()))  // add current season
        )
      ).sort((a,b)=>b.localeCompare(a));
      return Object.keys(remote.ladder);
    });

    $sel(".ladderBox > h1").addEventListener("click", async ()=>{
      ladderDate = await ladderChooser.choose() || ladderDate;
      refreshUI();
    });
    ladderCtrl.sync().then(refreshUI);
  </script>
</body>
</html>