<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KDALadder</title>
  <link rel="stylesheet" href="res/icomoon/style.css">
  <link rel="stylesheet" href="res/style.css">
</head>
<body class="index">
  <div class="bodyItem ladderBox active">
    <div class="topmenu">
      <div class="item active" data-target=".mainLadder">
        总榜
      </div>
      <div class="item" data-target=".groupLadder">团体榜</div>
      <div class="item" data-target=".groupHistory">赛局记录</div>
      <div class="logo" onclick="popResult('about.html')">KDALadder.top</div>
    </div>
    <div class="indexBody">
      <div class="bodyItem mainLadder active">
        <iframe title="main ladder" data-src="hallladder.html" style="width: 100%; height: 100%; border: 0"></iframe>
      </div>
      <div class="bodyItem groupLadder">
        <iframe title="main ladder" data-src="ladder.html" style="width: 100%; height: 100%; border: 0"></iframe>
      </div>
      <div class="bodyItem groupHistory">
        <iframe title="main ladder" data-src="history.html" style="width: 100%; height: 100%; border: 0"></iframe>
      </div>
    </div>
  </div>
  <div class="bodyItem groupBox"> 
    <iframe title="main ladder" data-src="group.html" style="width: 100%; height: 100%; border: 0"></iframe>
  </div>

  <div class="botmenu">
    <button class="ladder active">
      <img alt="ranking" src="res/svg/ranking.svg" />
      <span>KDALadder</span>
    </button>
    <button class="newMatch">
      <img alt="new" src="res/svg/badminton.svg" />
      <span class="new">new</span>
    </button>
    <button class="myGroup">
      <img alt="team" src="res/svg/team.svg" />
      <span>我的团体</span>
    </button>
  </div>
  <div class="begin" style="display:none">
    <div class="box">
      <h1>KDALadder.top</h1>
      <small>欢迎来到kda天梯排行榜。在这里，你将会有如下技能：</small>
      <img alt="begin" src="res/svg/begin-pic2.svg" />
      <small>接下来：</small>
      <button onclick="begin()" class="beginBtn">开始使用 ></button>
      <small>或：</small>
      <button onclick="begin('more')" class="aboutBtn">了解更多 ></button>
    </div>
  </div>

  <!-- ListChooser -->
  <script id="DataListItem" type="text/template">
    <div class="item" data-data="{{data}}">
      <div class="data">{{data}}</div>
      <div class="subtitle">{{subtitle}}</div>
    </div>
  </script>
  <div class="dataList">
    <div class="list"></div>
    <div class="item cancelBtn">
      <div class="name">取消</div>
    </div>
  </div>

  <div class="pop-result">
    <iframe src="" title="result"></iframe>
    <button class="close-pop-result">关闭</button>
  </div>
  <script type="module">
    import * as App from './res/app.js'
    Object.assign(window, App);

    function loadIFrame(target) {
      if(!target.src)
        target.src = target.dataset["src"]
    }

    $sels(".topmenu .item").forEach(e => e.addEventListener("click", function(){
      $sels(".topmenu .item").forEach(e => e.classList.remove("active"));
      $sels(".indexBody .bodyItem").forEach(e => e.classList.remove("active"));
      this.classList.add("active");
      $sel(this.dataset.target).classList.add("active")

      loadIFrame($sel(`${this.dataset.target} iframe`))
    }))

    $sel(".newMatch").addEventListener("click", () => {
      if(!new GroupController().online) {
        $alert("请先登录")
        $sel(".myGroup").click();
      } else {
        location.href = "match.html"
      }
    })
    $sel(".ladder").addEventListener("click", () => {
      $sels("body>div").forEach(e => e.classList.remove("active"));
      $sels(".botmenu>button").forEach(e => e.classList.remove("active"));
      $sel(".ladder").classList.add("active");
      $sel(".ladderBox").classList.add("active");
    })
    $sel(".myGroup").addEventListener("click", () => {
      $sels("body>div").forEach(e => e.classList.remove("active"));
      $sels(".botmenu>button").forEach(e => e.classList.remove("active"));
      $sel(".myGroup").classList.add("active");
      $sel(".groupBox").classList.add("active");
      loadIFrame($sel(".groupBox iframe"))
    })


    $sel(".close-pop-result").addEventListener("click", () => {
      $sel('.pop-result').classList.remove('show');
      $popHistoryBack();
      let iframe = $sel(".pop-result iframe").contentDocument;
      iframe.removeChild(iframe.documentElement)
    })

    if(!localStorage.getItem("__showBegin")) {
      $sel(".begin").style.display = "block"
    }
    window.begin = (more) => {
      if(more) {
        popResult("about.html")
      } else {
        localStorage.setItem("__showBegin", "false");
      $sel(".begin").style.display = "none"
      }
    }

    window.popResult = (url) => {
      $sel(".pop-result iframe").src = url;
      $sel(".pop-result").classList.add('show')
      $pushHistoryBack(()=>{
        $sel('.pop-result').classList.remove('show');
      })
    }

    window.refreshAll = () => { // refresh on login/logout
      $sel(".groupLadder iframe").contentWindow.location.reload()
      $sel(".groupHistory iframe").contentWindow.location.reload()
    }

    loadIFrame($sel(".mainLadder iframe"))
    
  </script>
</body>
</html>