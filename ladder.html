<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ladder</title>
  <link rel="stylesheet" href="res/icomoon/style.css">
  <link rel="stylesheet" href="res/style.css">
  <style>
    body {
      background: white
    }
    .matches {
      display: flex
    }
    .matches .item {
      margin: 5px;
      padding: 5px;
    }
    .matches .item .title {
      color: gray
    }
    .matches .item .score {
      color: red
    }
  </style>
</head>
<body class="ladder">

  <div class="box ladderBox">
    <h1 class="season" style="display:none"># KDA排名</h1>
    <h1 class="singleday" style="display:none"># 单日排名</h1>
    <small>2022-season1</small>
    <script id="LadderItem" type="text/template">
      <div class="item">
        <div class="name">{{name}}</div>
        <div class="score" style="width:{{width}}%"><span>{{score}}</span></div>
      </div>
    </script>

    <div title="总分 &nbsp; 击杀 / 失误 / 助攻 / &nbsp;  胜率% ( 胜场数 / 败场数 )" class="ladder-help place-holder-owner">
      <i class="icon-medal"></i> &nbsp; <i class="icon-kda-k"></i> / <i class="icon-kda-d"></i> / <i class="icon-kda-a"></i> / &nbsp;  <i class="icon-win"></i>% ( <i class="icon-win"></i> / <i class="icon-loss"></i> )
    </div>
    <div class="ladder-help place-holder">
      总分 &nbsp; 击杀 / 失误 / 助攻 / &nbsp;  胜率% ( 胜场数 / 败场数 )
    </div>
    <div class="ladder">
    </div>
  </div>
  </div>
  <script type="module">
    import * as App from './res/app.js'
    import { LocalStorage } from './res/storage-localstorage.js'
    Object.assign(window, App);

    let ladderCtrl = new LadderController();
    let ladderDate;

    async function refreshUI() {

      
      try {
        $sel("div.ladder").innerHTML = "loading..."

        if(!ladderDate) {
          let todayHasLadder = !!(await ladderCtrl.dateLadder()).ladder.length;
          ladderDate = todayHasLadder? $dateString(new Date()): $seasonString(new Date())
        }

        let ladder = ladderDate.indexOf("season") >= 0? 
            await ladderCtrl.seasonLadder(ladderDate): 
            await ladderCtrl.dateLadder(ladderDate);

        $sel(".ladderBox small").innerHTML = ladderDate;
        if(ladderDate.indexOf("season") >= 0) {
          $sel(".ladderBox > h1.season").style.display = ""
          $sel(".ladderBox > h1.singleday").style.display = "none"
        } else {
          $sel(".ladderBox > h1.season").style.display = "none"
          $sel(".ladderBox > h1.singleday").style.display = ""
        }

        if(ladder && ladder.ladder.length) {

          // ladder 
          
          var tmpl = $sel("#LadderItem").innerHTML;

          let maxScore = ladder.ladder[0].score;
          $sel("div.ladder").innerHTML = ladder.ladder
            // filter out win+loss < 10 in season ladder
            .filter(i => ladderDate.indexOf("season") >= 0? i.win + i.loss > 10: true)
            .map(i => {
              let width = Math.floor(i.score / maxScore * 100 * 0.7);
              let item = tmpl.replace("{{name}}", i.person)
                .replace(/{{score}}/g, $kdaString(i, true))
                .replace("{{width}}", width)
              return item;
            }).join("");

        } else {
          $sel("div.ladder").innerHTML = "暂无数据"
        }
      } catch(err) {
        if(err && err.message == "need login") {
          $sel("div.ladder").innerHTML = "请登录"
        }
      }



    }

    let prevSeason = [1,2,3].map(i => {
      let date = new Date();
      date.setDate(1);
      date.setMonth(date.getMonth() - 3 * i)
      return $seasonString(date);
    })
    let ladderChooser = new parent.ListChooser(() => {
      let remote = new LocalStorage("remote");
      let allDates = Array.from(
        new Set(
          Object.values(remote.ladder).reduce((pre,nxt) => pre.concat(nxt), []) // all ladders
            .map(i => $dateString(new Date(i.beginTime))) // map to dateString
            // .concat($dateString(new Date()))  // add today
            .concat(Object.keys(remote.ladder)) // add seasonString
            .concat($seasonString(new Date()))  // add current season
            .concat(prevSeason)
        )
      ).sort((a,b)=>b.localeCompare(a));
      return allDates;
    });

    $sels(".ladderBox > h1").forEach(i => i.addEventListener("click", async ()=>{
      ladderDate = await ladderChooser.choose() || ladderDate;
      refreshUI();
    }));

    refreshUI();
  </script>
</body>
</html>